{{ $modes_formation := slice }}
{{ $modes := index .Ancestors 2 }}
{{ range $modes.Pages }}
    {{ $modes_formation = $modes_formation | append . }}
{{ end }}
{{ $mode_formation := index .Ancestors 1 }}
{{ $module := index .Ancestors 0 }}
{{ $orientation := index .Ancestors 2 }}
{{ $unit := .Params.json_content }}
{{ $autres_programmes := partial "unit/get_other_programs_unit" . }}
{{ $pdf_link := printf "%s/pdf%s%s.pdf" .Site.BaseURL .RelPermalink ($unit.unite_abreviation | urlize) }}
<div class="card pdf-content">
    <div class="card-header d-flex align-center flex-row bd-highlight mb-3 unit-title">
        <div class="p-2 d-flex align-content-center flex-wrap flex-grow-1 bd-highlight">
            <b> {{ $unit.unite_nom }} </b>
            <div class="container">
                {{ $unit.unite_abreviation }} {{ $unit.unite_annee }}
                {{ range $i, $mf := $modes_formation }}
                    {{ $mode_formation := $mf.Params.json_content }}
                    {{ if eq $i 0 }}
                        {{ $mode_formation.mode_formation_abreviation }}
                    {{ else }}
                    - {{ $mode_formation.mode_formation_abreviation }}
                    {{ end }}
                {{ end }}
            </div>
            <div class="container" data-html2canvas-ignore="true">
                ({{ i18n "belongs_to_module" }} : <a href="{{ $module.Permalink }}"> {{ $module.Params.json_content.module_nom }} </a>)
            </div>
        </div>
        <div class="p-2 bd-highlight d-flex align-content-center flex-wrap" data-html2canvas-ignore="true">
            <div class="dropdown">
                <a class="btn btn-custom dropdown-toggle" role="button" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    {{ i18n "programs" }}
                </a>
                <ul class="dropdown-menu">
                    {{ range $autres_programmes }}
                    {{ $m := .Params.json_content }}
                    <li>
                        <a class="dropdown-item" href="{{ .page.Permalink }}"> {{ .formation }} {{ .mode }} </a>
                    </li>
                    {{ end }}
                </ul>
            </div>
            <button class="btn btn-custom" onclick="openAndDownloadPDF('{{ $pdf_link }}')">
                PDF
            </button>
        </div>
    </div>
    <div class="card-body d-flex flex-column">
        <div class="d-flex flex-column unit-general-infos">
            <div class="p-2 d-flex flex-row">
                <div class="w-50 d-flex align-content-center">
                    <b> {{ i18n "code" }} </b>
                </div>
                <div>
                    : {{ $unit.unite_abreviation }}
                </div>
            </div>
            <div class="p-2 d-flex flex-row">
                <div class="w-50 d-flex align-content-center">
                    <b> {{ i18n "orientation" }} </b>
                </div>
                <div>
                    : {{ $orientation.Params.json_content.formation_nom }}
                </div>
            </div>
            <div class="p-2 d-flex flex-row">
                <div class="w-50 d-flex align-content-center">
                    <b> {{ i18n "academic_years" }}  </b> 
                </div>
                <div>
                    : {{ partial "list_as_str" $unit.unite_validite}}
                </div>
            </div>
            <div class="p-2 d-flex flex-row">
                <div class="w-50 d-flex align-content-center">
                    <b> {{ i18n "formation_mode" }} </b> 
                </div>
                <div>
                    : {{ $mode_formation.Params.json_content.mode_formation_nom }}
                </div>
            </div>
            <div class="p-2 d-flex flex-row">
                <div class="w-50 d-flex align-content-center">
                    <b> {{ i18n "responsible_teacher" }} </b>
                </div>
                <div>
                    : {{ $unit.unite_responsable_nom }}
                </div>
            </div>
            <div class="p-2 d-flex flex-row">
                <div class="w-50 d-flex align-content-center">
                    <b> {{ i18n "workload" }} </b>
                </div>
                <div>
                    : {{ $unit.unite_charge }} {{ i18n "study_hours" }}
                </div>
            </div>
            <div class="p-2 d-flex flex-row">
                <div class="w-50 d-flex align-content-center">
                    <b> {{ i18n "instruction_main_languages" }} </b>
                </div>
                <div>
                    : {{ $unit.unite_langue }}
                </div>
            </div>
        </div>
        <div class="d-flex flex-column">
            <div class="p-2 unit-periods">
                <b> {{ i18n "supervised_periods" | strings.FirstUpper}} </b>
                <div class="p-2">
                    <div class="p-2">
                        {{ $periodes := (partial "get_unit_total_periods" $unit) }}
                        <b> {{ $periodes }} </b>   {{ i18n "periods" }} 
                    </div>
                    <div>
                        {{ i18n "corresponding_to" }}
                    </div>
                    <div class="p-2">
                        <b>{{int (mul $periodes 0.75)}} </b> {{ i18n "hours" }}
                    </div>
                </div>
            </div>
            <div class="p-2 unit-periods-table">
                <b> {{ i18n "position_of" | strings.FirstUpper }} {{ i18n "supervised_periods" }} </b>
                <div class="p-2">
                    {{ $cols := partial "get_semesters" ($mode_formation.Params.json_content.formation_duree_semestres) }}
                    {{ $types := partial "get_teaching_methods" $unit }}
                    {{ $unit_ctx := dict
                        "unite" $unit
                        "cols" $cols
                        "types" $types
                        }}
                    {{ partial "unit/unit_schedule_table.html" $unit_ctx }}
                </div>
            </div>
            <div class="p-2 unit-objectives">
                <b> {{ i18n "objectives" }} </b>
                <div class="p-2">
                    {{ $unit.unite_objectifs | safeHTML }}
                </div>
            </div>
            <div class="p-2 unit-prior-knowledge">
                <b> {{ i18n "recommended_prior_knowledge" | strings.FirstUpper}} </b>
                <div class="p-2">
                    {{ $unit.unite_connaissances_prealables | safeHTML }}
                </div>
            </div>
            <div class="p-2 unit-content">
                <div>
                    <b> {{ i18n "content_teaching_methods" }} </b>
                </div>
                <div>
                    <i> {{ i18n "informative_periods_repartition" }} </i>
                </div>                
                <div class="p-2">
                    {{ range $unit.contenu_et_formes }}
                        {{ partial "unit/unit_content" . }}
                    {{ end }}
                </div>
            </div>
            <div class="p-2 unit-bibliography">
                <b> {{ i18n "bibliography" }} </b>
                <div class="p-2">
                    {{ $unit.unite_bibliographie | safeHTML }}
                </div>
            </div>
            <div class="p-2 unit-controls">
                <div class="d-flex flex-row">
                    <div class="p-2 d-flex flex-column w-75">
                        <b> {{ i18n "knowledge_control" | strings.FirstUpper }} </b>
                        {{ range $unit.ponderations }}
                            <div class="p-2">
                                <div>
                                    <b> {{ .type_enseignement_nom }} : </b>
                                </div>
                                <div class="w-100">
                                    {{ .controle_connaissances }}
                                </div>
                            </div>
                        {{ end }}
                    </div>
                    <div class="p-2 d-flex flex-column">
                        <div>
                            <b> {{ i18n "final_grade" }} </b>
                        </div>
                        <div>
                            {{ $ponderation_tot := 0 }}
                            {{ range $unit.ponderations }}
                                {{ $ponderation_tot = add $ponderation_tot .ponderation }}
                            {{ end }}
                            {{ range $unit.ponderations }}
                                <div class="d-flex flex-row">
                                    <div class="p-2 w-75">
                                        {{ .type_enseignement_nom }}
                                    </div>
                                    <div class="p-2">
                                        {{ if eq $ponderation_tot 0 }}
                                            {{ $ponderation_tot = 100 }}
                                        {{ end }}
                                        {{ mul (div .ponderation $ponderation_tot) 100 }}%
                                    </div>
                                </div>
                            {{ end }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>